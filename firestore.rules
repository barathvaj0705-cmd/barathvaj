/**
 * This ruleset enforces a strict user-ownership model for a StudyBuddy AI application.
 *
 * Core Philosophy:
 * The security model is designed to be highly secure and private. Each user has a dedicated
 * data tree, and all of their data, including profiles, quizzes, and interactions, is
 * stored within that tree. A user can only access data that exists under their own
 * unique user ID.
 *
 * Data Structure:
 * All user-specific data is nested under the `/users/{userId}` path, where `{userId}`
 * corresponds to the user's Firebase Authentication UID. This hierarchical structure
 * makes authorization checks simple, performant, and directly tied to the document path.
 *
 * Key Security Decisions:
 * - Strict Data Isolation: Users are strictly confined to their own data tree (`/users/{userId}`).
 *   Cross-user data access is explicitly forbidden.
 * - User Enumeration Disabled: Listing the top-level `/users` collection is disallowed to
 *   protect user privacy and prevent data scraping.
 * - Path-Based Security: Ownership is determined by the document path, avoiding the need for
 *   costly `get()` calls to other documents for authorization.
 * - Relational Integrity: On creation, documents within a user's tree (e.g., a quiz) must
 *   contain a `userProfileId` field that correctly references the parent user, ensuring data
 *   consistency. This field is immutable once set.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document exists and if the requester is the owner.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Validates required ownership fields for a new UserProfile.
     * Ensures the document's internal ID matches the user's auth UID.
     */
    function hasValidUserProfileDataOnCreate(userId) {
      let data = request.resource.data;
      return data.id == userId;
    }
    
    /**
     * Enforces immutability of the UserProfile's unique ID upon update.
     */
    function isUserProfileDataImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates required ownership fields for new subcollection documents.
     * Ensures the document's internal userProfileId matches the user's auth UID in the path.
     */
    function hasValidOwnershipLinkOnCreate(userId) {
      let data = request.resource.data;
      return data.userProfileId == userId;
    }

    /**
     * Enforces immutability of the ownership link field (userProfileId) upon update.
     */
    function isOwnershipLinkImmutable() {
      return request.resource.data.userProfileId == resource.data.userProfileId;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. A user can create their own profile,
     *              and read or update it, but cannot delete it. Listing users is disallowed.
     * @path        /users/{userId}
     * @allow       (create) A newly signed-up user (auth.uid: 'user_abc') creating their own
     *              profile document at `/users/user_abc`.
     * @deny        (list) Any user trying to list all documents in the `/users` collection.
     * @principle   Restricts access to a user's own data tree and allows self-creation of a root user document.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserProfileDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && isUserProfileDataImmutable();
      allow delete: if false;

      /**
       * @description Manages quizzes owned by a specific user. Only the owner can
       *              create, read, update, or delete their own quizzes.
       * @path        /users/{userId}/quizzes/{quizId}
       * @allow       (create) An authenticated user (auth.uid: 'user_abc') creating a quiz
       *              at `/users/user_abc/quizzes/quiz_123`.
       * @deny        (get) A different user (auth.uid: 'user_xyz') trying to read a quiz
       *              at `/users/user_abc/quizzes/quiz_123`.
       * @principle   Enforces document ownership for all operations within a user's private subcollection.
       */
      match /quizzes/{quizId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidOwnershipLinkOnCreate(userId);
        allow update: if isExistingOwner(userId) && isOwnershipLinkImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages quiz results for a specific user. Only the owner can
       *              create, read, update, or delete their own results.
       * @path        /users/{userId}/quizResults/{quizResultId}
       * @allow       (list) An authenticated user (auth.uid: 'user_abc') listing their own
       *              results from `/users/user_abc/quizResults`.
       * @deny        (update) A different user (auth.uid: 'user_xyz') trying to modify a result
       *              at `/users/user_abc/quizResults/result_456`.
       * @principle   Enforces document ownership for all operations within a user's private subcollection.
       */
      match /quizResults/{quizResultId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidOwnershipLinkOnCreate(userId);
        allow update: if isExistingOwner(userId) && isOwnershipLinkImmutable();
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages chatbot interactions for a specific user. Only the owner
       *              can create, read, update, or delete their own interactions.
       * @path        /users/{userId}/chatbotInteractions/{chatbotInteractionId}
       * @allow       (delete) An authenticated user (auth.uid: 'user_abc') deleting their own
       *              interaction at `/users/user_abc/chatbotInteractions/chat_789`.
       * @deny        (create) A different user (auth.uid: 'user_xyz') trying to create an
       *              interaction at `/users/user_abc/chatbotInteractions/chat_101`.
       * @principle   Enforces document ownership for all operations within a user's private subcollection.
       */
      match /chatbotInteractions/{chatbotInteractionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidOwnershipLinkOnCreate(userId);
        allow update: if isExistingOwner(userId) && isOwnershipLinkImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}